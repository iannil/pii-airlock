# PII-AIRLOCK 技术架构设计

> 文档版本：v1.0
> 创建日期：2026-01-21
> 状态：已实现

## 1. 系统定位

PII-AIRLOCK 是一个开源的、可本地部署的中间件/反向代理，部署在企业内网或私有云（VPC）中，位于企业业务系统与公网 LLM（如 OpenAI API）之间。

**核心价值**：让公有大模型私有化 (Make Public LLMs Private)

## 2. 系统架构图

```
┌─────────────────┐     ┌─────────────────────────────────────┐     ┌─────────────────┐
│                 │     │           PII-AIRLOCK               │     │                 │
│  企业业务系统    │────▶│  ┌─────────┐    ┌─────────────────┐ │────▶│   公有 LLM API   │
│  (Dify/LangChain)│     │  │ 脱敏引擎 │────│ Redis 映射存储   │ │     │  (OpenAI/Claude) │
│                 │◀────│  └─────────┘    └─────────────────┘ │◀────│                 │
└─────────────────┘     └─────────────────────────────────────┘     └─────────────────┘
```

## 3. 核心处理流程

### 3.1 六步工作流

| 步骤 | 名称 | 描述 |
|------|------|------|
| 1 | 拦截 (Intercept) | 捕获客户端发出的 Prompt |
| 2 | 脱敏 (Redact) | NLP 引擎识别敏感实体，生成带语义的占位符 |
| 3 | 映射 (Map) | 在 Redis 中存储 PII→占位符映射，设置 TTL |
| 4 | 转发 (Forward) | 将清洗后的 Prompt 发送给 LLM |
| 5 | 回填 (Re-hydrate) | 将响应中的占位符替换为原始值 |
| 6 | 返回 (Return) | 将结果返回客户端 |

### 3.2 类型保留脱敏示例

**输入**：
```
请帮我给张三(13800000000)写一封催款邮件。
```

**脱敏后发送给 LLM**：
```
请帮我给<PERSON_1>(<PHONE_1>)写一封催款邮件。
```

**LLM 返回**：
```
亲爱的<PERSON_1>，请您尽快处理...
```

**回填后返回客户端**：
```
亲爱的张三，请您尽快处理...
```

## 4. 技术栈

| 组件 | 技术选型 | 说明 |
|------|----------|------|
| 语言 | Python | MVP 阶段首选，NLP 生态最好 |
| Web 框架 | FastAPI | 高性能，异步支持，适合流式响应 |
| NER 引擎 | Microsoft Presidio | 微软开源 PII 识别库，可扩展性强 |
| 辅助 NLP | spaCy / HuggingFace | 本地运行轻量级模型 |
| 存储 | Redis | 快速映射存储，支持 TTL 自动过期 |
| 部署 | Docker | 一行命令启动 |

## 5. API 兼容性

完全兼容 OpenAI API 标准格式：

```python
# 用户只需修改 base_url
client = OpenAI(
    base_url="http://pii-airlock:8000/v1",  # 改为代理地址
    api_key="your-openai-key"
)
```

## 6. 关键技术难点

### 6.1 流式响应处理 (SSE)

**问题**：LLM 逐字输出时，占位符可能被截断（如 `<PERSON` 和 `_1>` 分两次到达）

**方案**：滑动窗口缓冲
- 缓存约 20 个字符
- 检测完整占位符后再进行替换和推送

### 6.2 LLM 幻觉与占位符篡改

**问题**：LLM 可能将 `<PERSON_1>` 改写为 `<Person 1>` 或 `<Name_1>`

**方案**：
1. System Prompt 注入防篡改指令
2. 回填阶段使用模糊正则匹配

### 6.3 自定义敏感词

**方案**：支持 `regex.yaml` 配置文件

```yaml
custom_patterns:
  - name: PROJECT_CODE
    pattern: "PROJ-\\d{4}"
  - name: EMPLOYEE_ID
    pattern: "EMP[A-Z]\\d{6}"
```

## 7. 支持的 PII 类型

| 类型 | 占位符格式 | 示例 |
|------|-----------|------|
| 姓名 | `<PERSON_N>` | 张三 → `<PERSON_1>` |
| 手机号 | `<PHONE_N>` | 13800000000 → `<PHONE_1>` |
| 邮箱 | `<EMAIL_N>` | test@example.com → `<EMAIL_1>` |
| 身份证 | `<ID_CARD_N>` | 110101199001011234 → `<ID_CARD_1>` |
| 银行卡 | `<CREDIT_CARD_N>` | 6222021234567890123 → `<CREDIT_CARD_1>` |
| IP 地址 | `<IP_N>` | 192.168.1.1 → `<IP_1>` |
| API Key | `<API_KEY_N>` | sk-xxx → `<API_KEY_1>` |
