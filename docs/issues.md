# PII-AIRLOCK 剩余问题清单

> 本文档整理了 PII-AIRLOCK 项目的所有待修复问题，按 **全局→局部**、**高风险→低风险**、**高优先级→低优先级** 排列。
>
> 生成时间：2026-01-23

---

## 一、架构与安全问题（全局/高风险）

### 1.1 认证与授权缺陷

| ID | 问题 | 文件位置 | 严重性 | 说明 |
|----|------|---------|--------|------|
| ~~SEC-001~~ | ~~公开的测试/管理端点无认证~~ | ~~`api/auth_middleware.py:37-44`~~ | ~~**严重**~~ | ✅ 已修复: SENSITIVE_PATHS + PII_AIRLOCK_SECURE_ENDPOINTS=true |
| ~~SEC-002~~ | ~~租户 ID Header 注入~~ | ~~`api/auth_middleware.py:138-157`~~ | ~~**高**~~ | ✅ 已修复: PII_AIRLOCK_ALLOW_HEADER_TENANT 控制 |
| ~~SEC-003~~ | ~~API Key 完整记录到日志~~ | ~~`api/middleware.py:70,79`~~ | ~~**高**~~ | ✅ 已修复: _mask_api_key() 函数脱敏 |
| ~~SEC-004~~ | ~~错误消息泄露内部信息~~ | ~~`api/routes.py:248,322`~~ | ~~**高**~~ | ✅ 已修复: 返回 "Internal server error" |

### 1.2 数据隔离问题

| ID | 问题 | 文件位置 | 严重性 | 说明 |
|----|------|---------|--------|------|
| ~~SEC-005~~ | ~~映射键无租户前缀（单租户模式）~~ | ~~`core/mapping.py`~~ | ~~**中高**~~ | ✅ 已修复: 始终使用租户前缀 |
| ~~SEC-006~~ | ~~合成数据跨会话一致~~ | ~~`core/anonymizer.py:407-432`~~ | ~~**中**~~ | ✅ 已修复: 会话隔离种子机制 |

### 1.3 流式处理安全

| ID | 问题 | 文件位置 | 严重性 | 说明 |
|----|------|---------|--------|------|
| ~~SEC-007~~ | ~~流式缓冲占位符提取不完整~~ | ~~`core/stream_buffer.py:175`~~ | ~~**高**~~ | ✅ 已修复: 更严格的正则 `<[A-Z][A-Z_]*(?:_\d*)?$` |
| ~~SEC-008~~ | ~~映射 TTL 在长流中过期~~ | ~~`api/proxy.py:677`~~ | ~~**中**~~ | ✅ 已修复: 流式期间定期延长 TTL |
| ~~SEC-009~~ | ~~最大长度绕过~~ | ~~`core/stream_buffer.py:180-184`~~ | ~~**中**~~ | ✅ 已修复: 改进长占位符处理逻辑 |

---

## 二、核心功能缺陷（模块级/中高风险）

### 2.1 脱敏/回填引擎

| ID | 问题 | 文件位置 | 严重性 | 说明 |
|----|------|---------|--------|------|
| ~~CORE-001~~ | ~~模糊匹配默认关闭~~ | ~~`core/deanonymizer.py:166-191`~~ | ~~**中**~~ | ✅ 已修复: PII_AIRLOCK_FUZZY_MATCHING=true 启用 |
| ~~CORE-002~~ | ~~意图检测类型不全~~ | ~~`core/anonymizer.py:586`~~ | ~~**中**~~ | ✅ 已修复: PII_AIRLOCK_QUESTION_FAVOR_TYPES 可配置 |
| ~~CORE-003~~ | ~~Embedding 端点无 PII 保护~~ | ~~`api/routes.py:266-322`~~ | ~~**中**~~ | ✅ 已修复: 输入文本先脱敏再发送 |

### 2.2 异常处理

| ID | 问题 | 文件位置 | 严重性 | 说明 |
|----|------|---------|--------|------|
| ~~CORE-004~~ | ~~过于宽泛的 except Exception~~ | ~~多处（16处）~~ | ~~**中**~~ | ✅ 已修复: 添加日志记录 |
| ~~CORE-005~~ | ~~配额检查返回值不一致~~ | ~~`api/proxy.py:596-599,856-870`~~ | ~~**低**~~ | ✅ 已修复: 流式返回一致的错误事件格式 |
| ~~CORE-006~~ | ~~JSON 解析静默跳过~~ | ~~`api/proxy.py:975`~~ | ~~**低**~~ | ✅ 已修复: 添加警告日志 |

---

## 三、测试覆盖不足（质量风险）

### 3.1 关键模块无测试

| ID | 模块 | 文件 | 优先级 | 影响 |
|----|------|------|--------|------|
| ~~TEST-001~~ | ~~代理服务~~ | ~~`api/proxy.py`~~ | ~~极高~~ | ✅ 已完成 (38 tests) |
| ~~TEST-002~~ | ~~API 路由~~ | ~~`api/routes.py`~~ | ~~极高~~ | ✅ 已完成 (28 tests) |
| ~~TEST-003~~ | ~~认证中间件~~ | ~~`api/auth_middleware.py`~~ | ~~高~~ | ✅ 已完成 (29 tests) |
| ~~TEST-004~~ | ~~合规 API~~ | ~~`api/compliance_api.py`~~ | ~~高~~ | ✅ 已完成 (28 tests) |
| ~~TEST-005~~ | ~~审计 API~~ | ~~`api/audit_api.py`~~ | ~~中~~ | ✅ 已完成 (24 tests) |
| ~~TEST-006~~ | ~~Redis 存储~~ | ~~`storage/redis_store.py`~~ | ~~中~~ | ✅ 已完成 (33 tests) |
| ~~TEST-007~~ | ~~RBAC~~ | ~~`auth/rbac.py`~~ | ~~中~~ | ✅ 已完成 (39 tests) |

### 3.2 边界条件缺失

| ID | 场景 | 优先级 |
|----|------|--------|
| ~~TEST-008~~ | ~~空 PII 映射处理~~ | ~~高~~ | ✅ 已完成 (test_edge_cases.py) |
| ~~TEST-009~~ | ~~超长文本（>100KB）处理~~ | ~~中~~ | ✅ 已完成 (test_edge_cases.py) |
| ~~TEST-010~~ | ~~并发访问映射存储~~ | ~~中~~ | ✅ 已完成 (test_edge_cases.py) |
| ~~TEST-011~~ | ~~缓存过期边界~~ | ~~中~~ | ✅ 已完成 (test_edge_cases.py) |
| ~~TEST-012~~ | ~~配额临界值~~ | ~~低~~ | ✅ 已完成 (test_edge_cases.py) |

---

## 四、代码质量问题（维护风险）

### 4.1 代码重复

| ID | 问题 | 文件位置 | 说明 |
|----|------|---------|------|
| ~~CODE-001~~ | ~~`_hash_string` 方法重复 4 处~~ | ~~`core/synthetic/*.py`~~ | ✅ 已修复: 提取到 `base.py` 基类 |

### 4.2 类型注解

| ID | 问题 | 文件位置 | 说明 |
|----|------|---------|------|
| CODE-002 | 多处 `type: ignore` | `utils/performance.py:49,97,316,366,368` | 应修复根本类型问题 |
| CODE-003 | 装饰器返回值类型不完整 | `utils/performance.py` | 需要改进泛型注解 |

### 4.3 依赖管理

| ID | 问题 | 说明 |
|----|------|------|
| DEP-001 | FastAPI/Uvicorn 版本较旧 | 当前 0.100+/0.23+，建议升级到 0.110+/0.28+ |
| DEP-002 | slowapi 长期未维护 | 最后更新 2022 年，考虑替代方案 |

---

## 五、配置与部署问题

### 5.1 危险默认值

| ID | 问题 | 文件位置 | 严重性 | 说明 |
|----|------|---------|--------|------|
| ~~CFG-001~~ | ~~绑定 0.0.0.0~~ | ~~`docker-compose.yml:9`~~ | ~~**中**~~ | ✅ 已修复: 可通过 PII_AIRLOCK_HOST 配置 |
| ~~CFG-002~~ | ~~Redis 无认证~~ | ~~`docker-compose.yml:20-26`~~ | ~~**中**~~ | ✅ 已修复: 支持 REDIS_PASSWORD 配置 |
| CFG-003 | API Key 回退逻辑 | `api/routes.py:91` | **低** | `PII_AIRLOCK_API_KEY` 空时回退到 `OPENAI_API_KEY`，可能非预期 |

### 5.2 Dockerfile 安全

| ID | 问题 | 文件位置 | 说明 |
|----|------|---------|------|
| ~~CFG-004~~ | ~~以 root 运行容器~~ | ~~`Dockerfile:24`~~ | ✅ 已修复: 创建 appuser 非特权用户 |
| CFG-005 | spaCy 模型不一致 | `Dockerfile:18` | 使用 `zh_core_web_sm`，文档推荐 `zh_core_web_trf` |

### 5.3 Docker Compose 缺陷

| ID | 问题 | 说明 |
|----|------|------|
| ~~CFG-006~~ | ~~无健康检查~~ | ✅ 已修复: 添加 healthcheck 配置 |
| ~~CFG-007~~ | ~~无资源限制~~ | ✅ 已修复: 添加 CPU/内存限制 |
| ~~CFG-008~~ | ~~无日志轮转~~ | ✅ 已修复: 添加 json-file 日志驱动配置 |
| ~~CFG-009~~ | ~~Redis 无持久化~~ | ✅ 已修复: appendonly + volume 持久化 |

### 5.4 环境变量

| ID | 问题 | 说明 |
|----|------|------|
| ~~CFG-010~~ | ~~缺少启动时验证~~ | ✅ 已修复: main.py validate_environment() |
| CFG-011 | `.env.example` 不完整 | 缺少多租户、配额等高级配置示例 |

---

## 六、文档问题

### 6.1 版本与同步

| ID | 问题 | 说明 |
|----|------|------|
| DOC-001 | 版本号混乱 | CLAUDE.md="Phase 7.1"，README="v2.0.0"，pyproject.toml="1.1.0" |
| DOC-002 | 中英文文档不同步 | README.md (EN) vs README_zh.md/CLAUDE.md (CN) 内容差异 |

### 6.2 缺失文档

| ID | 缺失内容 | 优先级 |
|----|---------|--------|
| ~~DOC-003~~ | ~~管理 API 文档 (`/api/v1/compliance/*`, `/api/v1/audit/*`)~~ | ~~高~~ | ✅ 已完成 (docs/api/management-api.md) |
| ~~DOC-004~~ | ~~多租户配置指南~~ | ~~高~~ | ✅ 已完成 (docs/guides/multi-tenant.md) |
| ~~DOC-005~~ | ~~故障排查指南~~ | ~~中~~ | ✅ 已完成 (docs/guides/troubleshooting.md) |
| DOC-006 | 性能调优指南 | 中 |
| DOC-007 | 安全加固指南 | 中 |
| DOC-008 | API 错误代码参考 | 低 |
| DOC-009 | 迁移指南 | 低 |

---

## 七、运维监控问题

### 7.1 健康检查

| ID | 问题 | 文件位置 | 说明 |
|----|------|---------|------|
| ~~OPS-001~~ | ~~/health 不检查依赖~~ | ~~`api/routes.py:151-153`~~ | ✅ 已修复: /ready 端点检查所有依赖 |
| ~~OPS-002~~ | ~~缺少 /ready 端点~~ | ~~-~~ | ✅ 已修复: 新增 /ready 端点 (liveness vs readiness) |

### 7.2 监控指标缺失

| ID | 缺失指标 | 说明 |
|----|---------|------|
| ~~OPS-003~~ | ~~映射存储大小~~ | ✅ 已存在 (MAPPING_STORE_SIZE) |
| ~~OPS-004~~ | ~~缓存命中率~~ | ✅ 已完成 (CACHE_HITS/CACHE_MISSES) |
| ~~OPS-005~~ | ~~PII 类型分布~~ | ✅ 已存在 (PII_DETECTED + entity_type label) |
| ~~OPS-006~~ | ~~本地处理延迟~~ | ✅ 已完成 (ANONYMIZATION/DEANONYMIZATION/SECRET_SCAN_DURATION) |

### 7.3 审计日志

| ID | 问题 | 说明 |
|----|------|------|
| ~~OPS-007~~ | ~~配置变更未审计~~ | ✅ 已修复: compliance_api.py 添加审计日志 |
| ~~OPS-008~~ | ~~API Key 操作未审计~~ | ✅ 已修复: routes.py 添加 API Key 操作审计 |

---

## 八、修复优先级建议

### P0 - 立即修复（安全关键）

1. ~~**SEC-001** 公开端点添加认证~~ ✅
2. ~~**SEC-003** API Key 日志脱敏（仅记录哈希前缀）~~ ✅
3. ~~**SEC-004** 错误消息清理，不暴露内部细节~~ ✅
4. ~~**SEC-007** 修复流式缓冲占位符正则~~ ✅

### P1 - 短期修复（1-2 周）

1. ~~**TEST-001/002** 添加 proxy.py 和 routes.py 单元测试~~ ✅
2. ~~**SEC-002** 租户 ID 验证加强~~ ✅
3. **CFG-004** Dockerfile 非 root 用户
4. **DOC-001** 统一版本号
5. **CFG-010** 启动时环境变量验证

### P2 - 中期改进（2-4 周）

1. ~~**TEST-003~007** 补充其他模块测试~~ ✅
2. ~~**CORE-001** 启用模糊匹配或改进占位符鲁棒性~~ ✅
3. ~~**SEC-008** 流式场景 TTL 延长机制~~ ✅
4. ~~**OPS-001/002** 完善健康检查~~ ✅
5. ~~**DOC-003~005** 补充关键文档~~ ✅

### P3 - 长期优化（4+ 周）

1. ~~**CODE-001** 消除代码重复~~ ✅
2. **DEP-001/002** 依赖升级
3. ~~**OPS-003~006** 完善监控指标~~ ✅
4. **DOC-006~009** 补充辅助文档

---

## 附录：问题统计

| 类别 | 数量 | 高风险 | 中风险 | 低风险 |
|------|------|--------|--------|--------|
| 安全问题 | 9 | 5 | 4 | 0 |
| 核心功能 | 6 | 1 | 3 | 2 |
| 测试覆盖 | 12 | 3 | 6 | 3 |
| 代码质量 | 5 | 0 | 2 | 3 |
| 配置部署 | 11 | 0 | 5 | 6 |
| 文档 | 9 | 0 | 3 | 6 |
| 运维监控 | 8 | 0 | 4 | 4 |
| **合计** | **60** | **9** | **27** | **24** |
